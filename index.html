// Function to fetch and display available seasons
async function fetchSeasons(imdbID) {
    const seasonSelect = document.getElementById('season-select');
    const episodeSelect = document.getElementById('episode-select');

    seasonSelect.style.display = 'block'; // Show season selector
    episodeSelect.style.display = 'block'; // Show episode selector

    const seasonUrl = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&i=${imdbID}&type=series`;

    let keepFetching = true;
    let season = 1;

    // Clear the season select options
    seasonSelect.innerHTML = '';

    while (keepFetching) {
        const response = await fetch(`${seasonUrl}&Season=${season}`);
        const data = await response.json();

        if (data.Response === "True" && data.Episodes) {
            // Create a new option for each season
            const option = document.createElement('option');
            option.value = season;
            option.textContent = `Season ${season}`;
            seasonSelect.appendChild(option);

            // If it's the first season, fetch and display episodes immediately
            if (season === 1) {
                populateEpisodes(imdbID, season); // Populate episodes for the first season
            }

            season++;
        } else {
            // No more seasons
            keepFetching = false;
        }
    }

    // If there is only one season, automatically populate episodes for it
    if (season === 2) {
        populateEpisodes(imdbID, 1); // Handle single season
    }
}

// Function to populate episodes based on selected season
function populateEpisodes(imdbID, selectedSeason) {
    const episodeSelect = document.getElementById('episode-select');
    
    episodeSelect.innerHTML = ''; // Clear previous options
    fetchEpisodes(imdbID, selectedSeason).then(episodes => {
        episodes.forEach(episode => {
            const option = document.createElement('option');
            option.value = episode.Episode;
            option.textContent = `Episode ${episode.Episode}: ${episode.Title}`;
            episodeSelect.appendChild(option);
        });
        
        // Automatically select the first episode in the dropdown
        if (episodes.length > 0) {
            episodeSelect.selectedIndex = 0;
        }
    });
}

// Function to fetch episodes for a specific season
async function fetchEpisodes(imdbID, season) {
    const episodeUrl = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&i=${imdbID}&Season=${season}`;
    const response = await fetch(episodeUrl);
    const data = await response.json();
    return data.Episodes || []; // Return episodes or an empty array if none
}

// Add event listener to the season-select to trigger episode population
document.getElementById('season-select').addEventListener('change', function() {
    const imdbID = document.querySelector('.result-item button').getAttribute('onclick').match(/'([^']+)'/)[1];
    const selectedSeason = this.value;
    populateEpisodes(imdbID, selectedSeason);
});
